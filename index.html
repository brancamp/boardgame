<html>

<head>
    <title>Board Game</title>
    <style>
        body {
            overflow: hidden;
            margin: 0;
        }

    </style>
    <script src="three.js/build/three.min.js"></script>
    <script src="player.js"></script>
    <script src="gamecontroller.js"></script>
    <script src="movebutton.js"></script>
    <script src='cameracontrol.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/16.3.5/Tween.min.js"></script>

</head>

<body>
    <script>
        var mouse = new THREE.Vector2();
        var scene = new THREE.Scene();
        var boardSize = 21;
        var axes = new THREE.AxesHelper(20);
        scene.add(axes);
        var buttons = [];
        var stackables = [];
        var dragging = true;
        var raycaster = new THREE.Raycaster();


        //Set up the camera
        let camSize = 20;
        var aspect = window.innerWidth / window.innerHeight;
        let camera = new THREE.OrthographicCamera(-camSize * aspect, camSize * aspect, camSize, -camSize, 0, 1000);
        camera.position.set(10, 15, 10);
        camera.lookAt(scene.position);
        var cameraHolder = new CameraControl(camera);

        //Renderer
        var renderer = new THREE.WebGLRenderer({
            antialias: true
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);


        //create the board
        var boxGeo = new THREE.BoxGeometry(boardSize, 1, boardSize);
        var boxMat = new THREE.MeshBasicMaterial({
            color: 0xcccccc
        });
        var board = new THREE.Mesh(boxGeo, boxMat);
        scene.add(board);


        //invisible plane
        var planeGeo = new THREE.PlaneGeometry(boardSize, boardSize);
        var planeMat = new THREE.MeshBasicMaterial({
            color: 0xffffff,
            transparent: true,
            opacity: 0

        });
        var placementPlane = new THREE.Mesh(planeGeo, planeMat);
        placementPlane.rotation.x = -Math.PI / 2;
        placementPlane.position.y = 6;
        scene.add(placementPlane);

        //create the box placement helper
        var helperBoxGeo = new THREE.BoxGeometry(1, 1, 1);
        var helperBoxMat = new THREE.MeshBasicMaterial({
            color: 0xff0000,
            wireframe: true
        });
        var helperBoxMesh = new THREE.Mesh(helperBoxGeo, helperBoxMat);
        var helperBox = new THREE.Object3D();
        helperBox.add(helperBoxMesh);
        helperBoxMesh.position.y = 0.5;
        helperBox.position.set(0, 1000, 0);
        scene.add(helperBox);




        //add the players
        var player1 = new Player(0, Math.floor(boardSize / 2));
        var player2 = new Player(0, -Math.floor(boardSize / 2));
        var currPlayer = player2;


        //create the move buttons
        var north = new MoveButton('north');
        north.place(0, 0, -(boardSize / 2 + 4));
        var south = new MoveButton('south');
        south.place(0, 0, (boardSize / 2 + 4));
        var east = new MoveButton('east');
        east.place((boardSize / 2 + 4), 0, 0);
        var west = new MoveButton('west');
        west.place(-(boardSize / 2 + 4), 0, 0);
        buttons.push(north.mesh, south.mesh, east.mesh, west.mesh);

        //add a box
        function addBox() {
            var b = new Box(helperBox.position);
        }


        //Event listeners
        window.addEventListener('resize', resizeHandler);
        window.addEventListener('keydown', keyHandler);
        window.addEventListener('click', clickHandler);
        window.addEventListener('mousemove', moveHandler);

        update();

        //handle mouse moves
        function moveHandler() {
            if (dragging) {
                mouse.set((event.clientX / window.innerWidth) * 2 - 1, -(event.clientY / window.innerHeight) * 2 + 1);
                raycaster.setFromCamera(mouse, camera);
                var intersects = raycaster.intersectObjects(stackables);

                if (intersects.length > 0) {
                    var dir = new THREE.Vector3(0, -1, 0);
                    var origin = intersects[0].point;
                    raycaster.set(origin, dir);
                    var hit = raycaster.intersectObject(board)[0].point;
                    helperBox.position.copy(hit);
                    helperBox.position.x = Math.round(helperBox.position.x);
                    //helperBox.position.y = Math.round(helperBox.position.y);
                    helperBox.position.z = Math.round(helperBox.position.z);

                } else {
                    helperBox.position.set(0, 1000, 0);
                }

            }
        }

        //handle all clicks
        function clickHandler(e) {
            var caster = new THREE.Raycaster();
            mouse.set((event.clientX / window.innerWidth) * 2 - 1, -(event.clientY / window.innerHeight) * 2 + 1);
            caster.setFromCamera(mouse, camera);
            var intersects = caster.intersectObjects(buttons);

            if (intersects.length > 0) {
                var clicked = intersects[0];
                switch (clicked.object.name) {
                    case 'north':
                        currPlayer.move('north');
                        break;
                    case 'south':
                        currPlayer.move('south');
                        break;
                    case 'east':
                        currPlayer.move('east');
                        break;
                    case 'west':
                        currPlayer.move('west');
                        break;
                }
            }
        }

        //handle resize
        function resizeHandler() {
            var aspect = window.innerWidth / window.innerHeight;
            camera.left = -aspect * camSize;
            camera.right = aspect * camSize;
            camera.top = camSize;
            camera.bottom = -camSize;

            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        //update loop
        function update() {
            requestAnimationFrame(update);
            renderer.render(scene, camera);
            TWEEN.update();


        }

        //handle all keypresses
        function keyHandler(e) {
            switch (e.keyCode) {
                case 37:
                    cameraHolder.rotate('left');
                    break;
                case 39:
                    cameraHolder.rotate('right');
                    break;
            }
        }

    </script>
</body>


</html>
